<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Subjects and Year Groups</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .form-section {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin: 5px 0;
        }
        select, input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0 15px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .button:hover {
            background-color: #45a049;
        }
        .result-section {
            margin-top: 20px;
        }
        .sample-prompt {
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>

    <h1>Manage Subjects and Year Groups</h1>

    <div id="form-container">
        <div class="form-section">
            <label for="subject-select">Select Subject:</label>
            <select id="subject-select" onchange="loadYearGroups()">
                <option value="">-- Select Subject --</option>
                <!-- Options will be populated dynamically -->
            </select>

            <label for="year-group-select">Select Year Group:</label>
            <select id="year-group-select" onchange="loadPrompt()">
                <option value="">-- Select Year Group --</option>
                <!-- Options will be populated dynamically -->
            </select>
        </div>

        <div class="form-section">
            <label for="prompt-text">Prompt Text:</label>
            <textarea id="prompt-text" rows="4"></textarea>
            <p class="sample-prompt">Sample Prompt: Generate a concise school report for a pupil. This is for school lessons and I would like it to be friendly and formal. I would like it to be between 100 and 170 words long and flow nicely with no repetition. Below are categories and comments to base the report on. There should be no headings on the report. It could have up to 3 paragraphs if necessary.</p>
        </div>

        <button class="button" onclick="savePrompt()">Save Prompt</button>
    </div>

    <div id="result-container" class="result-section"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadSubjects();
        });

        async function loadSubjects() {
            const response = await fetch('/api/subjects');
            const subjects = await response.json();
            const subjectSelect = document.getElementById('subject-select');
            subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.name;
                subjectSelect.appendChild(option);
            });
        }

        async function loadYearGroups() {
            const subjectId = document.getElementById('subject-select').value;
            const response = await fetch('/api/year-groups');
            const yearGroups = await response.json();
            const yearGroupSelect = document.getElementById('year-group-select');
            yearGroupSelect.innerHTML = '<option value="">-- Select Year Group --</option>';
            yearGroups.forEach(yearGroup => {
                const option = document.createElement('option');
                option.value = yearGroup.id;
                option.textContent = yearGroup.name;
                yearGroupSelect.appendChild(option);
            });
        }

        async function loadPrompt() {
            const subjectId = document.getElementById('subject-select').value;
            const yearGroupId = document.getElementById('year-group-select').value;
            if (subjectId && yearGroupId) {
                const response = await fetch(`/api/prompts/${subjectId}/${yearGroupId}`);
                const promptPart = await response.json();

                const defaultPrompt = "Generate a concise school report for a pupil. This is for school lessons and I would like it to be friendly and formal. I would like it to be between 100 and 170 words long and flow nicely with no repetition. Below are categories and comments to base the report on. There should be no headings on the report. It could have up to 3 paragraphs if necessary.";

                if (!promptPart || promptPart === '') {
                    document.getElementById('prompt-text').value = defaultPrompt;
                } else {
                    document.getElementById('prompt-text').value = promptPart;
                }
            }
        }

        async function savePrompt() {
            const subjectId = document.getElementById('subject-select').value;
            const yearGroupId = document.getElementById('year-group-select').value;
            const promptPart = document.getElementById('prompt-text').value;

            // Check if the prompt exists
            const checkResponse = await fetch(`/api/prompts/${subjectId}/${yearGroupId}`);
            const existingPrompt = await checkResponse.json();

            let method;
            let url;

            if (existingPrompt && existingPrompt !== '') {
                method = 'PUT';
                url = `/api/prompts/${subjectId}/${yearGroupId}`;
            } else {
                method = 'POST';
                url = '/api/prompts';
            }

            const responseSave = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    subjectId,
                    yearGroupId,
                    promptPart
                })
            });

            if (responseSave.ok) {
                alert('Prompt saved successfully!');
            } else {
                alert('Error saving prompt.');
            }
        }
    </script>

</body>
</html>
