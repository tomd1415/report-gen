<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Comments and Categories</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .category {
            cursor: pointer;
            background-color: #ffffff;
            border: 2px solid #002D72;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .category-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #002D72;
        }

        .category-content {
            display: none;
            margin-top: 10px;
        }

        .category.active .category-content {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Include header -->
    <div id="header-placeholder"></div>
    
    <h1 class="main-title">Manage Comments and Categories</h1>
    <div id="form-container">
        <div class="form-section">
            <label for="year-group-select">Year Group:</label>
            <select id="year-group-select" onchange="loadCategoriesAndComments()" class="form-control">
                <option value="">-- Select Year Group --</option>
            </select>
        </div>

        <div class="form-section">
            <label for="subject-select">Subject:</label>
            <select id="subject-select" onchange="loadCategoriesAndComments()" class="form-control">
                <option value="">-- Select Subject --</option>
            </select>
        </div>

        <div class="form-section">
            <label for="new-category-name">New Category Name:</label>
            <input type="text" id="new-category-name" placeholder="Enter new category name" class="input-text">
            <button class="button" onclick="addCategory()">Add Category</button>
        </div>
    </div>
    <div id="categories-container" class="category-container">
        <!-- Categories and comments will be populated here -->
    </div>

    <script>
        // Function to load header
        document.addEventListener("DOMContentLoaded", function() {
            fetch("header.html")
                .then(response => response.text())
                .then(data => {
                    document.getElementById("header-placeholder").innerHTML = data;
                });
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadYearGroups();
            loadSubjects();
        });

        async function loadYearGroups() {
            try {
                const response = await fetch('/api/year-groups');
                if (!response.ok) {
                    console.error('Failed to fetch year groups:', response.statusText);
                    return;
                }
                const yearGroups = await response.json();
                const yearGroupSelect = document.getElementById('year-group-select');
                yearGroups.forEach(yearGroup => {
                    const option = document.createElement('option');
                    option.value = yearGroup.id;
                    option.textContent = yearGroup.name;
                    yearGroupSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading year groups:', error);
            }
        }

        async function loadSubjects() {
            try {
                const response = await fetch('/api/subjects');
                if (!response.ok) {
                    console.error('Failed to fetch subjects:', response.statusText);
                    return;
                }
                const subjects = await response.json();
                const subjectSelect = document.getElementById('subject-select');
                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.name;
                    subjectSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading subjects:', error);
            }
        }

        async function loadCategoriesAndComments() {
            const subjectId = document.getElementById('subject-select').value;
            const yearGroupId = document.getElementById('year-group-select').value;
            if (subjectId && yearGroupId) {
                try {
                    const response = await fetch(`/api/categories-comments?subjectId=${subjectId}&yearGroupId=${yearGroupId}`);
                    if (!response.ok) {
                        console.error('Failed to fetch categories and comments:', response.statusText);
                        return;
                    }
                    const categories = await response.json();
                    const categoriesContainer = document.getElementById('categories-container');
                    categoriesContainer.innerHTML = '';
                    categories.forEach(category => {
                        const categoryDiv = document.createElement('div');
                        categoryDiv.classList.add('category');
                        categoryDiv.innerHTML = `
                            <div class="category-title" onclick="toggleCategory(this)">${category.name}</div>
                            <div class="category-content">
                                <button class="button delete" onclick="deleteCategory(${category.id})">Delete Category</button>
                                <div>
                                    ${category.Comments.map(comment => `
                                        <div class="comment" draggable="true" ondragstart="drag(event)" data-comment-id="${comment.id}">
                                            <div class="comment-content" contenteditable="true" onblur="editComment(${comment.id}, this.textContent)">${comment.text}</div>
                                            <div class="comment-actions">
                                                <select onchange="moveComment(${comment.id}, this.value)">
                                                    <option value="">Move to...</option>
                                                    ${categories.map(cat => `
                                                        <option value="${cat.id}" ${cat.id === category.id ? 'disabled' : ''}>${cat.name}</option>
                                                    `).join('')}
                                                </select>
                                                <button class="button delete" onclick="deleteComment(${comment.id})">Delete</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                    <div>
                                        <textarea rows="2" placeholder="Add new comment"></textarea>
                                        <button class="button addcomment" onclick="addComment(${category.id}, this.previousElementSibling.value)">Add Comment</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        categoryDiv.addEventListener('drop', drop);
                        categoryDiv.addEventListener('dragover', allowDrop);
                        categoriesContainer.appendChild(categoryDiv);
                    });
                } catch (error) {
                    console.error('Error loading categories and comments:', error);
                }
            }
        }

        function toggleCategory(element) {
            const category = element.parentElement;
            category.classList.toggle('active');
        }

        async function addCategory() {
            const name = document.getElementById('new-category-name').value;
            const subjectId = document.getElementById('subject-select').value;
            const yearGroupId = document.getElementById('year-group-select').value;
            if (name && subjectId && yearGroupId) {
                try {
                    const response = await fetch('/api/categories', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name, subjectId, yearGroupId })
                    });
                    if (!response.ok) {
                        console.error('Error adding category:', response.statusText);
                        alert('Error adding category.');
                        return;
                    }
                    document.getElementById('new-category-name').value = '';
                    loadCategoriesAndComments();
                } catch (error) {
                    console.error('Error adding category:', error);
                    alert('Error adding category.');
                }
            } else {
                alert('Please enter a name and select a subject and year group.');
            }
        }

        async function editCategory(id, newName) {
            if (newName) {
                try {
                    const response = await fetch(`/api/categories/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name: newName })
                    });
                    if (!response.ok) {
                        console.error('Error editing category:', response.statusText);
                        alert('Error editing category.');
                    }
                } catch (error) {
                    console.error('Error editing category:', error);
                    alert('Error editing category.');
                }
            }
        }

        async function deleteCategory(id) {
            if (confirm('Are you sure you want to delete this category? All comments in this category will also be deleted.')) {
                try {
                    const response = await fetch(`/api/categories/${id}`, {
                        method: 'DELETE'
                    });
                    if (!response.ok) {
                        console.error('Error deleting category:', response.statusText);
                        alert('Error deleting category.');
                        return;
                    }
                    loadCategoriesAndComments();
                } catch (error) {
                    console.error('Error deleting category:', error);
                    alert('Error deleting category.');
                }
            }
        }

        async function addComment(categoryId, text) {
            if (text) {
                try {
                    const response = await fetch('/api/comments', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ text, categoryId })
                    });
                    if (!response.ok) {
                        console.error('Error adding comment:', response.statusText);
                        alert('Error adding comment.');
                        return;
                    }
                    loadCategoriesAndComments();
                } catch (error) {
                    console.error('Error adding comment:', error);
                    alert('Error adding comment.');
                }
            } else {
                alert('Please enter a comment.');
            }
        }

        async function editComment(id, newText) {
            if (newText) {
                try {
                    const response = await fetch(`/api/comments/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ text: newText })
                    });
                    if (!response.ok) {
                        console.error('Error editing comment:', response.statusText);
                        alert('Error editing comment.');
                    }
                } catch (error) {
                    console.error('Error editing comment:', error);
                    alert('Error editing comment.');
                }
            }
        }

        async function deleteComment(id) {
            if (confirm('Are you sure you want to delete this comment?')) {
                try {
                    const response = await fetch(`/api/comments/${id}`, {
                        method: 'DELETE'
                    });
                    if (!response.ok) {
                        console.error('Error deleting comment:', response.statusText);
                        alert('Error deleting comment.');
                        return;
                    }
                    loadCategoriesAndComments();
                } catch (error) {
                    console.error('Error deleting comment:', error);
                    alert('Error deleting comment.');
                }
            }
        }

        async function moveComment(commentId, newCategoryId) {
            if (newCategoryId) {
                try {
                    const response = await fetch('/api/move-comment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ commentId, newCategoryId })
                    });
                    if (!response.ok) {
                        console.error('Error moving comment:', response.statusText);
                        alert('Error moving comment.');
                        return;
                    }
                    loadCategoriesAndComments();
                } catch (error) {
                    console.error('Error moving comment:', error);
                    alert('Error moving comment.');
                }
            }
        }

        function allowDrop(event) {
            event.preventDefault();
        }

        function drag(event) {
            event.dataTransfer.setData('text', event.target.getAttribute('data-comment-id'));
        }

        async function drop(event) {
            event.preventDefault();
            const commentId = event.dataTransfer.getData('text');
            const newCategoryId = event.target.closest('.category').querySelector('.category-title').dataset.categoryId;
            if (commentId && newCategoryId) {
                try {
                    const response = await fetch('/api/move-comment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ commentId, newCategoryId })
                    });
                    if (!response.ok) {
                        console.error('Error moving comment:', response.statusText);
                        alert('Error moving comment.');
                        return;
                    }
                    loadCategoriesAndComments();
                } catch (error) {
                    console.error('Error moving comment:', error);
                    alert('Error moving comment.');
                }
            }
        }
    </script>
</body>
</html>
