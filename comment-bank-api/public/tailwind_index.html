<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comment Bank Selector</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-blue-100 text-gray-900">

    <div id="header-placeholder"></div>
    <div class="container mx-auto p-4 bg-blue-100 rounded-lg shadow-lg">
        <h1 class="text-3xl font-bold mb-4 text-center">Generate Report</h1>

        <div id="form-container">
            <div class="subject-year">
                <div class="form-section">
                    <select id="subject-select" onchange="loadCategoriesAndComments()"
                        class="border border-gray-300 rounded-md shadow-sm text-2xl text-center bg-green-200">
                        <option value="">Select Subject</option>
                    </select>
                </div>

                <div class="form-section">
                    <select id="year-group-select" onchange="loadCategoriesAndComments()"
                        class="border border-gray-300 rounded-md shadow-sm text-2xl text-center bg-green-200">
                        <option value="">Select Year Group</option>
                    </select>
                </div>
            </div>

            <div id="name-pronoun-section" class="flex justify-center space-x-4">
                <div class="flex flex-col items-center">
                    <input type="text" id="pupil-name" required class="border border-gray-300 rounded-md shadow-sm mb-0 p-1 text-center">
                    <label for="pupil-name" class="block text-center">Pupil Name</label>
                </div>
                <div class="flex flex-col items-center">
                    <input type="text" id="pupil-pronouns" required class="border border-gray-300 rounded-md shadow-sm mb-0 p-1 text-center">
                    <label for="pupil-pronouns" class="block text-center">Pronouns</label>
                </div>
            </div>
            

            <div id="categories-container" class="comment-categories-container"></div>

            <div class="form-section">
                <label for="additional-comments">Additional Comments:</label>
                <textarea id="additional-comments" rows="4"
                    class="w-full border border-gray-300 rounded-md shadow-sm"
                    placeholder="Add any additional comments about the pupil here..."></textarea>
            </div>

            <button class="button bg-blue-600 text-white px-4 py-2 rounded-md" onclick="generateReport()">Generate
                Report</button>
        </div>

        <div id="result-container" class="result-section mt-4 p-4 bg-gray-100 rounded-md shadow-md border-slate-900 border-2"></div>
    </div>

    <div id="footer-placeholder"></div>

    <div id="add-comment-modal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-8">
            <h2 class="text-xl font-bold mb-4">Add New Comment</h2>
            <textarea id="new-comment-text" rows="4" class="w-full border border-gray-300 rounded-md shadow-sm mb-4"
                placeholder="Enter new comment"></textarea>
            <div class="flex justify-end">
                <button class="button bg-gray-600 text-white px-4 py-2 rounded-md mr-2" onclick="closeModal()">Cancel</button>
                <button class="button bg-blue-600 text-white px-4 py-2 rounded-md" onclick="saveNewComment()">Save Comment</button>
            </div>
        </div>
    </div>

    <script>
        // Function to load header
        document.addEventListener("DOMContentLoaded", function () {
            fetch("header.html")
                .then(response => response.text())
                .then(data => {
                    document.getElementById("header-placeholder").innerHTML = data;
                });
        });

        fetch('footer.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('footer-placeholder').innerHTML = data;
            });

        let pupils = [];
        let promptPart = 'Generate a comprehensive report for a student.';

        async function loadSubjects() {
            const response = await fetch('/api/subjects');
            const subjects = await response.json();
            const subjectSelect = document.getElementById('subject-select');
            subjectSelect.innerHTML = '<option value="">Select Subject</option>';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.name;
                subjectSelect.appendChild(option);
            });
        }

        async function loadYearGroups() {
            const response = await fetch('/api/year-groups');
            const yearGroups = await response.json();
            const yearGroupSelect = document.getElementById('year-group-select');
            yearGroupSelect.innerHTML = '<option value="">Select Year Group</option>';
            yearGroups.forEach(yearGroup => {
                const option = document.createElement('option');
                option.value = yearGroup.id;
                option.textContent = yearGroup.name;
                yearGroupSelect.appendChild(option);
            });
        }

        async function loadCategoriesAndComments() {
            const subjectId = document.getElementById('subject-select').value;
            const yearGroupId = document.getElementById('year-group-select').value;
            if (subjectId && yearGroupId) {
                console.log(`Fetching categories and comments for subjectId: ${subjectId}, yearGroupId: ${yearGroupId}`);

                const [categoriesResponse, promptPartResponse] = await Promise.all([
                    fetch(`/api/categories-comments?subjectId=${subjectId}&yearGroupId=${yearGroupId}`),
                    fetch(`/api/prompts?subjectId=${subjectId}&yearGroupId=${yearGroupId}`)
                ]);

                const categories = await categoriesResponse.json();
                promptPart = await promptPartResponse.text();

                console.log('Fetched categories:', categories);
                console.log('Fetched prompt part:', promptPart);

                const categoriesContainer = document.getElementById('categories-container');
                categoriesContainer.innerHTML = ''; // Clear previous options

                categories.forEach(category => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.classList.add('form-section', 'm-1', 'p-1', 'bg-blue-300', 'rounded-md', 'shadow-sm');
                    categoryDiv.classList.add('comment-category', 'm-0', 'p-0');

                    const label = document.createElement('label');
                    label.for = category.name.toLowerCase().replace(' ', '-');
                    label.textContent = category.name + ':';
                    categoryDiv.appendChild(label);

                    const select = document.createElement('select');
                    select.id = category.name.toLowerCase().replace(' ', '-');
                    select.innerHTML = '<option value="">-- Select Comment --</option>';
                    select.classList.add('border', 'border-gray-300', 'rounded-md', 'shadow-sm');

                    category.Comments.forEach(comment => {
                        const option = document.createElement('option');
                        option.value = comment.text;
                        option.textContent = comment.text;
                        select.appendChild(option);
                    });

                    // Add option to add new comment
                    const addOption = document.createElement('option');
                    addOption.value = "add-new";
                    addOption.textContent = "Add new comment";
                    select.appendChild(addOption);

                    select.addEventListener('change', () => {
                        if (select.value === "add-new") {
                            currentCategorySelect = select; // Keep track of the current select element
                            openModal(category.id);
                        }
                    });

                    categoryDiv.appendChild(select);
                    categoriesContainer.appendChild(categoryDiv);
                });
            }
        }

        let currentCategorySelect = null;

        async function addNewComment(categoryId, selectElement) {
            const commentText = prompt('Enter the new comment:');
            if (commentText) {
                try {
                    const response = await fetch('/api/comments', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ text: commentText, categoryId })
                    });
                    if (!response.ok) {
                        console.error('Error adding comment:', response.statusText);
                        alert('Error adding comment.');
                        return;
                    }
                    const newComment = await response.json();
                    const option = document.createElement('option');
                    option.value = newComment.text;
                    option.textContent = newComment.text;
                    selectElement.appendChild(option);
                    selectElement.value = newComment.text; // Select the newly added comment
                } catch (error) {
                    console.error('Error adding comment:', error);
                    alert('Error adding comment.');
                }
            }
        }

        function openModal(categoryId) {
            document.getElementById('add-comment-modal').classList.remove('hidden');
            document.getElementById('add-comment-modal').dataset.categoryId = categoryId;
        }

        function closeModal() {
            document.getElementById('add-comment-modal').classList.add('hidden');
            document.getElementById('new-comment-text').value = '';
        }

        async function saveNewComment() {
            const categoryId = document.getElementById('add-comment-modal').dataset.categoryId;
            const commentText = document.getElementById('new-comment-text').value;

            if (commentText) {
                try {
                    const response = await fetch('/api/comments', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ text: commentText, categoryId })
                    });
                    if (!response.ok) {
                        console.error('Error adding comment:', response.statusText);
                        alert('Error adding comment.');
                        return;
                    }
                    const newComment = await response.json();
                    const option = document.createElement('option');
                    option.value = newComment.text;
                    option.textContent = newComment.text;
                    currentCategorySelect.appendChild(option);
                    currentCategorySelect.value = newComment.text; // Select the newly added comment
                    closeModal();
                } catch (error) {
                    console.error('Error adding comment:', error);
                    alert('Error adding comment.');
                }
            }
        }

        async function generateReport() {
            const pupilName = document.getElementById('pupil-name').value;
            const pupilPronouns = document.getElementById('pupil-pronouns').value;
            const additionalComments = document.getElementById('additional-comments').value;

            const subjectId = document.getElementById('subject-select').value;
            const yearGroupId = document.getElementById('year-group-select').value;

            const categoriesContainer = document.getElementById('categories-container');
            const categorySelects = categoriesContainer.getElementsByTagName('select');

            const pupil = {
                name: pupilName,
                pronouns: pupilPronouns,
                subjectId: subjectId,
                yearGroupId: yearGroupId,
                additionalComments: additionalComments
            };

            Array.from(categorySelects).forEach(select => {
                const categoryName = select.id.replace('-', ' ');
                pupil[categoryName] = select.value;
            });

            let resultContainer = document.getElementById('result-container');
            resultContainer.innerHTML = '<h1>Generating Report</h1>'; // Clear previous results

            // Generate report for the pupil
            try {
                const response = await fetch('/generate-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(pupil)
                });
                const data = await response.json();
                let report = data.report;
                resultContainer.innerHTML = ''
                resultContainer.innerHTML += `<div><br />---------------------<br />${report}<br />------------------------<br /></div>`;
            } catch (error) {
                console.error('Error:', error);
                resultContainer.innerHTML += '<p>There was an error generating the report.</p>';
            }

            // Clear the form fields
            document.getElementById('pupil-name').value = '';
            document.getElementById('pupil-pronouns').value = '';
            document.getElementById('additional-comments').value = '';

            // Reset all comment selections to "-- Select Comment --"
            Array.from(categorySelects).forEach(select => {
                select.selectedIndex = 0;
            });
        }

        // Load subjects and year groups on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadSubjects();
            loadYearGroups();
        });
    </script>

</body>
</html>


